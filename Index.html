<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù† 1445</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .star {
            animation: twinkle 1.5s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .option-correct {
            background-color: rgba(34, 197, 94, 0.2) !important;
            border-color: rgb(34, 197, 94) !important;
        }

        .option-wrong {
            background-color: rgba(239, 68, 68, 0.2) !important;
            border-color: rgb(239, 68, 68) !important;
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .timer-warning {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-blue-900 to-indigo-950 min-h-screen">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ§Ø±ÙŠØ® -->
    <div class="bg-white/5 backdrop-blur-sm border-b border-white/10 p-3 text-white">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div id="day-name" class="text-blue-400"></div>
            <div id="current-date" class="text-green-400"></div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div id="start-screen" class="hidden min-h-[calc(100vh-64px)] text-white flex items-center justify-center p-6">
        <div class="max-w-md w-full">
            <div class="bg-white/10 backdrop-blur-lg border-2 border-green-400/20 rounded-3xl p-8">
                <div class="text-center space-y-6">
                    <div class="relative h-32">
                        <div class="floating">
                            <i data-lucide="moon" class="w-20 h-20 mx-auto text-yellow-400"></i>
                        </div>
                        <div class="absolute bottom-0 w-full flex justify-center gap-4">
                            <i data-lucide="star" class="star w-4 h-4 text-yellow-400"></i>
                            <i data-lucide="star" class="star w-4 h-4 text-yellow-400 delay-100"></i>
                            <i data-lucide="star" class="star w-4 h-4 text-yellow-400 delay-200"></i>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold text-yellow-400">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù†</h1>
                    <div class="space-y-4">
                        <label class="text-lg block text-center mb-2">
                            Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                        </label>
                        <input
                            type="text"
                            id="player-name"
                            placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ±ÙŠÙ…"
                            class="w-full bg-white/5 border-2 border-green-400/20 text-center text-lg py-6 rounded-xl text-white"
                        >
                    </div>
                    <button
                        id="start-button"
                        disabled
                        class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed text-white py-6 rounded-xl text-lg flex items-center justify-center gap-2"
                    >
                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                        Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø®Ø§Ø±Ø¬ ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© -->
    <div id="out-of-time-screen" class="hidden min-h-screen text-white flex items-center justify-center p-6">
        <div class="max-w-md w-full">
            <div class="bg-white/10 backdrop-blur-lg border-2 border-yellow-400/20 rounded-3xl p-8 text-center">
                <i data-lucide="clock" class="w-16 h-16 mx-auto text-yellow-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-yellow-400 mb-4">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
                <p class="text-gray-300 mb-6">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…ØªØ§Ø­Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 7 Ù…Ø³Ø§Ø¡Ù‹ Ø­ØªÙ‰ 8 Ù…Ø³Ø§Ø¡Ù‹</p>
                <div id="next-quiz-time" class="text-green-400 mb-6"></div>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    <div id="already-participated-screen" class="hidden min-h-screen text-white flex items-center justify-center p-6">
        <div class="max-w-md w-full">
            <div class="bg-white/10 backdrop-blur-lg border-2 border-red-400/20 rounded-3xl p-8 text-center">
                <i data-lucide="alert-circle" class="w-16 h-16 mx-auto text-red-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-red-400 mb-4">Ù„Ù‚Ø¯ Ø´Ø§Ø±ÙƒØª Ù…Ø³Ø¨Ù‚Ø§Ù‹</h2>
                <p class="text-gray-300 mb-6">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</p>
                <div id="next-participation-time" class="text-green-400 mb-6"></div>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ -->
    <div id="countdown-screen" class="hidden fixed inset-0 bg-blue-900/95 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="text-center slide-in">
            <div id="countdown-number" class="text-8xl font-bold text-yellow-400 mb-4"></div>
            <div id="countdown-text" class="text-2xl text-white"></div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
    <div id="quiz-screen" class="hidden min-h-screen text-white p-6">
        <div class="max-w-3xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-yellow-400 mb-2">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù†</h2>
                <p id="player-welcome" class="text-lg text-green-400"></p>
            </div>
            <div class="bg-white/10 backdrop-blur-lg border-2 border-green-400/20 rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                        <span id="timer" class="text-xl font-bold">15</span>
                    </div>
                    <div id="question-counter" class="text-lg"></div>
                </div>
                <div class="relative h-2 bg-gray-700/50 rounded-full overflow-hidden mb-6">
                    <div id="timer-bar" class="absolute top-0 left-0 h-full bg-green-400 transition-all duration-1000"></div>
                </div>
                <h3 id="question-text" class="text-xl font-semibold mb-6 pr-4 border-r-4 border-green-400"></h3>
                <div id="options-container" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div id="results-screen" class="hidden min-h-screen text-white p-6">
        <div class="max-w-2xl mx-auto">
            <div class="bg-white/10 backdrop-blur-lg border-2 border-yellow-400/30 rounded-2xl p-8">
                <i data-lucide="trophy" class="w-16 h-16 mx-auto text-yellow-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-yellow-400 mb-4 text-center">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>
                <p id="final-name" class="text-xl mb-4 text-center"></p>
                <p id="final-score" class="text-xl mb-6 text-center"></p>
                <div id="answers-review" class="space-y-4 mt-8"></div>
            </div>
        </div>
    </div>
</body>
</html>
<script>
// ØªÙ‡ÙŠØ¦Ø© Firebase
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
let db;
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
} catch (error) {
    console.error('Error initializing Firebase:', error);
}

// Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
const questionBank = [
    {
        question: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªØ¹Ø¯Ù„ Ø«Ù„Ø« Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ",
        options: ["Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©", "Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ«Ø±", "Ø³ÙˆØ±Ø© Ø§Ù„Ø¹ØµØ±"],
        correct: 1
    },
    {
        question: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø±ÙƒØ¹Ø§Øª ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­ØŸ",
        options: ["8 Ø±ÙƒØ¹Ø§Øª", "20 Ø±ÙƒØ¹Ø©", "11 Ø±ÙƒØ¹Ø©", "23 Ø±ÙƒØ¹Ø©"],
        correct: 1
    },
    {
        question: "ÙÙŠ Ø£ÙŠ Ù„ÙŠÙ„Ø© Ù…Ù† Ø±Ù…Ø¶Ø§Ù† ØªÙØ±Ø¬Ù‰ Ù„ÙŠÙ„Ø© Ø§Ù„Ù‚Ø¯Ø±ØŸ",
        options: ["Ù„ÙŠÙ„Ø© 21", "Ù„ÙŠÙ„Ø© 23", "Ù„ÙŠÙ„Ø© 27", "ÙƒÙ„ Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ Ø§Ù„ÙˆØªØ±ÙŠØ©"],
        correct: 3
    },
    {
        question: "Ù…Ø§ Ù‡Ùˆ Ø£ÙˆÙ„ Ù…Ø§ Ù†Ø²Ù„ Ù…Ù† Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ",
        options: ["Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…", "Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†", "ÙŠØ§ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù‚Ø±Ø£ Ø¨Ø§Ø³Ù… Ø±Ø¨Ùƒ"],
        correct: 3
    },
    {
        question: "ÙƒÙ… Ù…Ø±Ø© Ø°ÙÙƒØ±Øª ÙƒÙ„Ù…Ø© 'Ø±Ù…Ø¶Ø§Ù†' ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ",
        options: ["Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©", "Ù…Ø±ØªÙŠÙ†", "Ø«Ù„Ø§Ø« Ù…Ø±Ø§Øª", "Ø£Ø±Ø¨Ø¹ Ù…Ø±Ø§Øª"],
        correct: 0
    }
];

// Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
const gameState = {
    playerName: "",
    currentQuestion: 0,
    score: 0,
    answers: [],
    timeLeft: 15,
    timer: null,
    questions: [],
    questionStartTime: null,
    questionTimes: [],
    totalTime: 0,
    isAnswered: false,
    deviceId: null
};

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²
function generateDeviceId() {
    const userAgent = navigator.userAgent;
    const screenRes = `${window.screen.width}x${window.screen.height}`;
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const language = navigator.language;
    const deviceInfo = `${userAgent}|${screenRes}|${timezone}|${language}`;
    return CryptoJS.SHA256(deviceInfo).toString();
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
async function checkPreviousParticipation() {
    try {
        const deviceId = generateDeviceId();
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        const snapshot = await db.collection('participants')
            .where('deviceId', '==', deviceId)
            .where('timestamp', '>=', today)
            .get();

        if (!snapshot.empty) {
            const participation = snapshot.docs[0].data();
            const participationTime = participation.timestamp.toDate();
            const nextAllowedTime = new Date(participationTime);
            nextAllowedTime.setDate(nextAllowedTime.getDate() + 1);
            
            return {
                hasParticipated: true,
                nextAllowedTime: nextAllowedTime
            };
        }

        return {
            hasParticipated: false,
            nextAllowedTime: null
        };
    } catch (error) {
        console.error('Error checking participation:', error);
        throw error;
    }
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
async function recordParticipation() {
    try {
        const deviceId = generateDeviceId();
        const participationData = {
            deviceId: deviceId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            userAgent: navigator.userAgent,
            screenResolution: `${window.screen.width}x${window.screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };

        await db.collection('participants').add(participationData);
        gameState.deviceId = deviceId;
    } catch (error) {
        console.error('Error recording participation:', error);
        throw error;
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
function updateDateTime() {
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    const now = new Date();
    const dayName = days[now.getDay()];
    const date = now.toLocaleDateString('ar-SA');
    
    document.getElementById('day-name').textContent = dayName;
    document.getElementById('current-date').textContent = date;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
function checkQuizTime() {
    const now = new Date();
    const hours = now.getHours();
    return hours >= 19 && hours < 20; // Ù…Ù† 7 Ù…Ø³Ø§Ø¡Ù‹ Ø­ØªÙ‰ 8 Ù…Ø³Ø§Ø¡Ù‹
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
function startCountdown() {
    const countdownMessages = [
        { number: 5, text: "Ø§Ø³ØªØ¹Ø¯! Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø³ØªØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„ Ù„Ø­Ø¸Ø§Øª ğŸ¯" },
        { number: 4, text: "ØªØ°ÙƒØ±: Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ø¯Ù‚Ø© Ù…Ù‡Ù…Ø§Ù† ğŸš€" },
        { number: 3, text: "Ø±ÙƒØ² Ø¬ÙŠØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© â­" },
        { number: 2, text: "ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ†" },
        { number: 1, text: "Ø­Ø¸Ø§Ù‹ Ù…ÙˆÙÙ‚Ø§Ù‹! ğŸŒŸ" }
    ];

    let currentIndex = 0;
    document.getElementById('countdown-screen').classList.remove('hidden');
    
    function updateCountdown() {
        if (currentIndex >= countdownMessages.length) {
            document.getElementById('countdown-screen').classList.add('hidden');
            showQuestion();
            return;
        }

        const message = countdownMessages[currentIndex];
        document.getElementById('countdown-number').textContent = message.number;
        document.getElementById('countdown-text').textContent = message.text;

        currentIndex++;
        setTimeout(updateCountdown, 1000);
    }

    updateCountdown();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„
function showQuestion() {
    document.getElementById('quiz-screen').classList.remove('hidden');
    gameState.isAnswered = false;
    
    const question = gameState.questions[gameState.currentQuestion];
    document.getElementById('question-counter').textContent = 
        `Ø§Ù„Ø³Ø¤Ø§Ù„ ${gameState.currentQuestion + 1} Ù…Ù† ${gameState.questions.length}`;
    document.getElementById('question-text').textContent = question.question;
    
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = question.options.map((option, index) => `
        <button
            onclick="handleAnswer(${index})"
            class="w-full text-right bg-white/5 hover:bg-white/10 border-2 border-green-400/20 p-4 rounded-xl transition-colors"
        >
            ${option}
        </button>
    `).join('');

    gameState.questionStartTime = Date.now();
    startTimer();
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
function handleAnswer(selectedIndex) {
    if (gameState.isAnswered) return;
    gameState.isAnswered = true;
    
    clearInterval(gameState.timer);
    const answerTime = (Date.now() - gameState.questionStartTime) / 1000;
    gameState.questionTimes.push(answerTime);
    
    const question = gameState.questions[gameState.currentQuestion];
    const isCorrect = selectedIndex === question.correct;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
    let points = 0;
    if (isCorrect) {
        if (answerTime <= 3) points = 100;
        else if (answerTime <= 5) points = 80;
        else if (answerTime <= 10) points = 60;
        else points = 40;
    }
    
    gameState.score += points;
    gameState.totalTime += answerTime;

    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ©
    const options = document.getElementById('options-container').children;
    Array.from(options).forEach(option => {
        option.classList.add('option-disabled');
    });
    
    options[selectedIndex].classList.add(isCorrect ? 'option-correct' : 'option-wrong');
    if (!isCorrect) {
        options[question.correct].classList.add('option-correct');
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    gameState.answers.push({
        question: question.question,
        selectedAnswer: question.options[selectedIndex],
        correctAnswer: question.options[question.correct],
        isCorrect: isCorrect,
        time: answerTime,
        points: points
    });

    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
    setTimeout(() => {
        if (gameState.currentQuestion < gameState.questions.length - 1) {
            gameState.currentQuestion++;
            showQuestion();
        } else {
            showResults();
        }
    }, 1500);
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
function startTimer() {
    gameState.timeLeft = 15;
    const timerElement = document.getElementById('timer');
    const timerBar = document.getElementById('timer-bar');
    
    timerElement.textContent = gameState.timeLeft;
    timerBar.style.width = '100%';
    
    clearInterval(gameState.timer);
    gameState.timer = setInterval(() => {
        gameState.timeLeft--;
        timerElement.textContent = gameState.timeLeft;
        timerBar.style.width = `${(gameState.timeLeft / 15) * 100}%`;
        
        if (gameState.timeLeft <= 5) {
            timerElement.classList.add('timer-warning', 'text-red-400');
        }
        
        if (gameState.timeLeft <= 0) {
            clearInterval(gameState.timer);
            handleAnswer(-1);
        }
    }, 1000);
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
async function showResults() {
    try {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('results-screen').classList.remove('hidden');

        const playerData = {
            playerName: gameState.playerName,
            score: gameState.score,
            totalTime: gameState.totalTime,
            deviceId: gameState.deviceId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('scores').add(playerData);

        document.getElementById('final-name').textContent = `Ø§Ù„Ø§Ø³Ù…: ${gameState.playerName}`;
        document.getElementById('final-score').innerHTML = `
            Ø§Ù„Ù†Ù‚Ø§Ø·: ${gameState.score}<br>
            Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${gameState.totalTime.toFixed(2)} Ø«Ø§Ù†ÙŠØ©
        `;

        const answersHtml = gameState.answers.map((answer, index) => `
            <div class="bg-white/5 p-4 rounded-xl">
                <div class="font-bold mb-2">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}</div>
                <div class="text-sm opacity-90 mb-2">${answer.question}</div>
                <div class="text-sm ${answer.isCorrect ? 'text-green-400' : 'text-red-400'}">
                    Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${answer.selectedAnswer}
                    ${!answer.isCorrect ? `<br>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${answer.correctAnswer}` : ''}
                </div>
                <div class="text-sm mt-2">
                    Ø§Ù„ÙˆÙ‚Øª: ${answer.time.toFixed(2)} Ø«Ø§Ù†ÙŠØ©
                    <br>
                    Ø§Ù„Ù†Ù‚Ø§Ø·: ${answer.points}
                </div>
            </div>
        `).join('');

        document.getElementById('answers-review').innerHTML = answersHtml;
        lucide.createIcons();

    } catch (error) {
        console.error('Error saving results:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
async function startQuiz() {
    try {
        const participation = await checkPreviousParticipation();
        
        if (participation.hasParticipated) {
            showParticipationMessage(participation.nextAllowedTime);
            return;
        }

        await recordParticipation();
        
        gameState.playerName = document.getElementById('player-name').value.trim();
        gameState.questions = [...questionBank].sort(() => Math.random() - 0.5);
        
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('player-welcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${gameState.playerName}!`;
        
        startCountdown();
    } catch (error) {
        console.error('Error starting quiz:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
async function initializeQuiz() {
    try {
        updateDateTime();
        const isQuizTime = checkQuizTime();
        
        if (!isQuizTime) {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('out-of-time-screen').classList.remove('hidden');
            showNextQuizTime();
            return;
        }

        const participation = await checkPreviousParticipation();
        
        if (participation.hasParticipated) {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('already-participated-screen').classList.remove('hidden');
            showParticipationMessage(participation.nextAllowedTime);
            return;
        }

        document.getElementById('start-screen').classList.remove('hidden');
    } catch (error) {
        console.error('Error initializing quiz:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
document.getElementById('player-name').addEventListener('input', (e) => {
    document.getElementById('start-button').disabled = !e.target.value.trim();
});

document.getElementById('start-button').addEventListener('click', startQuiz);

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
setInterval(() => {
    if (!checkQuizTime()) {
        window.location.reload();
    }
}, 60000);

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', () => {
    try {
        lucide.createIcons();
        initializeQuiz();
    } catch (error) {
        console.error('Error initializing app:', error);
    }
});
</script>
